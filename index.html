<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAD Monitor - Traffic Health Dashboard</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Dashboard CSS with sidebar layout -->
    <link rel="stylesheet" href="assets/css/dashboard.css">

    <!-- CORS Direct Override (must load FIRST to override API client) -->
    <!-- <script src="assets/js/cors-direct-override.js"></script> -->

    <!-- Production Helper (must load before main.js) -->
    <script src="assets/js/production-helper.js"></script>

    <!-- JavaScript Entry Point -->
    <script type="module" src="assets/js/main.js?v=10"></script>
</head>
<body>
    <!-- Hidden input for server-side cookie -->
    <input type="hidden" id="elasticCookie" value="">

    <!-- Sidebar Control Panel -->
    <div class="control-panel">
        <div class="control-header">
            CONTROL PANEL
        </div>

        <div class="control-content">
            <!-- Connection Status -->
            <div class="control-section">
                <label class="control-label">Connection Status</label>
                <div id="connectionStatus" style="font-size: 12px; padding: 5px; background: #f0f0f0; text-align: center; border-radius: 3px;">
                    <span class="status-dot" style="display: inline-block; width: 8px; height: 8px; background: #ccc; border-radius: 50%; margin-right: 5px;"></span>
                    <span class="status-text">Connecting...</span>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="Dashboard.testApiConnection()" class="control-button secondary">Test Connection</button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="control-section">
                <label class="control-label">Quick Actions</label>
                <button onclick="Dashboard.refresh()" class="control-button" style="background: #2196F3; width: 100%; margin-bottom: 8px;">
                    <span style="font-size: 16px;">üîÑ</span> REFRESH DATA
                </button>
                <button onclick="showAdvancedEditor()" class="control-button" style="background: #4CAF50; width: 100%;">
                    <span style="font-size: 16px;">‚öôÔ∏è</span> CONFIGURATION
                </button>
                <div class="refresh-status" id="refreshStatus" style="margin-top: 8px;">Ready</div>
            </div>

            <!-- Additional Options -->
            <div class="control-section">
                <label class="control-label">Tools</label>
                <button onclick="ConfigManager.exportConfiguration()" class="control-button secondary" style="width: 100%; margin-bottom: 5px;">Export Config</button>
                <button onclick="Dashboard.showApiSetupInstructions()" class="control-button secondary" style="width: 100%;">Help</button>
            </div>

            <!-- Quick Stats -->
            <div class="control-section">
                <label class="control-label">Current Settings</label>
                <div style="font-size: 11px; color: #666; line-height: 1.6;">
                    <div><strong>Time Range:</strong> <span id="quickTimeRange">now-12h</span></div>
                    <div><strong>Baseline:</strong> <span id="quickBaseline">Loading...</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>RAD Traffic Health Monitor</h1>
                <div class="header-controls">
                    <button id="howItWorksBtn" class="info-button" onclick="showHowItWorksModal()">üìñ How It Works</button>
                    <div class="timestamp">Last updated: <span id="lastUpdate">Never</span></div>
                </div>
            </div>

            <div class="content">
                <!-- Summary Cards -->
                <div class="summary">
                    <div class="card critical">
                        <div class="label">CRITICAL</div>
                        <div id="criticalCount" class="value">0</div>
                        <div class="subtitle">Traffic dropped &gt;80%</div>
                    </div>
                    <div class="card warning">
                        <div class="label">WARNING</div>
                        <div id="warningCount" class="value">0</div>
                        <div class="subtitle">Traffic dropped 50-80%</div>
                    </div>
                    <div class="card normal">
                        <div class="label">NORMAL</div>
                        <div id="normalCount" class="value">0</div>
                        <div class="subtitle">Traffic as expected</div>
                    </div>
                    <div class="card increased">
                        <div class="label">INCREASED</div>
                        <div id="increasedCount" class="value">0</div>
                        <div class="subtitle">Traffic higher than usual</div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="filters">
                    <input type="text" id="searchInput" placeholder="Search events..." class="search-input">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">ALL</button>
                        <button class="filter-btn" data-filter="critical">CRITICAL</button>
                        <button class="filter-btn" data-filter="warning">WARNING</button>
                        <button class="filter-btn" data-filter="normal">NORMAL</button>
                        <button class="filter-btn" data-filter="increased">INCREASED</button>
                    </div>
                </div>

                <!-- RAD Type Filters -->
                <div class="rad-filters" style="margin-top: 10px;">
                    <label style="font-weight: 600; margin-right: 10px;">RAD Types:</label>
                    <div id="radTypeButtons" class="filter-buttons" style="display: inline-flex;">
                        <!-- RAD type buttons will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Baseline Health Check -->
                <div class="baseline-health-check" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">üîç Baseline Health Check</h3>
                    
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <!-- Healthy Window Configuration -->
                        <div style="flex: 1; min-width: 250px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #555;">Healthy Baseline Window</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 3px;">Start</label>
                                    <input type="datetime-local" id="healthyStart" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 3px;">End</label>
                                    <input type="datetime-local" id="healthyEnd" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #666;">
                                Quick presets: 
                                <a href="#" onclick="setHealthyPreset('july17'); return false;" style="color: #2196F3;">July 17</a> |
                                <a href="#" onclick="setHealthyPreset('last7days'); return false;" style="color: #2196F3;">Last 7 Days</a> |
                                <a href="#" onclick="setHealthyPreset('last30days'); return false;" style="color: #2196F3;">Last 30 Days</a>
                            </div>
                        </div>
                        
                        <!-- Recent Window Configuration -->
                        <div style="flex: 1; min-width: 250px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #555;">Recent Window to Compare</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 3px;">Start</label>
                                    <input type="datetime-local" id="recentStart" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 3px;">End</label>
                                    <input type="datetime-local" id="recentEnd" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #666;">
                                Quick presets: 
                                <a href="#" onclick="setRecentPreset('last15min'); return false;" style="color: #2196F3;">Last 15 min</a> |
                                <a href="#" onclick="setRecentPreset('last1hour'); return false;" style="color: #2196F3;">Last 1 hour</a> |
                                <a href="#" onclick="setRecentPreset('last6hours'); return false;" style="color: #2196F3;">Last 6 hours</a>
                            </div>
                        </div>
                        
                        <!-- EID Pattern Configuration -->
                        <div style="flex: 0 0 auto; min-width: 200px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #555;">EID Pattern</label>
                            <input type="text" id="eidPattern" value="pandc.vnext.recommendations.feed.feed*" 
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;"
                                   placeholder="e.g., pandc.vnext.*">
                            <button onclick="runBaselineHealthCheck()" 
                                    style="width: 100%; padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                üî¨ Run Health Check
                            </button>
                        </div>
                    </div>
                    
                    <!-- Results Display -->
                    <div id="baselineHealthResults" style="margin-top: 20px; display: none;">
                        <!-- Results will be dynamically inserted here -->
                    </div>
                </div>

                <!-- WAM General ET Monitoring Section -->
                <div class="wam-general-monitoring" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%); border-radius: 8px; border: 1px solid #FFB74D;">
                    <h3 style="margin: 0 0 15px 0; color: #E65100; font-size: 18px; display: flex; align-items: center;">
                        <span style="font-size: 24px; margin-right: 10px;">‚ö°</span> WAM General ET Monitoring
                        <span style="font-size: 12px; color: #666; margin-left: 10px; font-weight: normal;">(Evolved Metrics Analysis)</span>
                    </h3>
                    
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <!-- Baseline Window Configuration -->
                        <div style="flex: 1; min-width: 250px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #BF360C;">Baseline Window</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 3px;">Start</label>
                                    <input type="datetime-local" id="wamBaselineStart" style="width: 100%; padding: 5px; border: 1px solid #FFB74D; border-radius: 4px; background: #FFF8E1;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 3px;">End</label>
                                    <input type="datetime-local" id="wamBaselineEnd" style="width: 100%; padding: 5px; border: 1px solid #FFB74D; border-radius: 4px; background: #FFF8E1;">
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #666;">
                                Presets: 
                                <a href="#" onclick="Dashboard.WAM.setPreset('baseline', '6days'); return false;" style="color: #FF6F00; font-weight: 600;">6 days ago</a> |
                                <a href="#" onclick="Dashboard.WAM.setPreset('baseline', 'july17'); return false;" style="color: #FF6F00;">July 17</a> |
                                <a href="#" onclick="Dashboard.WAM.setPreset('baseline', 'custom'); return false;" style="color: #FF6F00;">Custom range</a>
                            </div>
                        </div>
                        
                        <!-- Recent Window Configuration -->
                        <div style="flex: 1; min-width: 250px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #BF360C;">Recent Window</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 3px;">Start</label>
                                    <input type="datetime-local" id="wamRecentStart" style="width: 100%; padding: 5px; border: 1px solid #FFB74D; border-radius: 4px; background: #FFF8E1;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 3px;">End</label>
                                    <input type="datetime-local" id="wamRecentEnd" style="width: 100%; padding: 5px; border: 1px solid #FFB74D; border-radius: 4px; background: #FFF8E1;">
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #666;">
                                Presets: 
                                <a href="#" onclick="Dashboard.WAM.setPreset('recent', '1h'); return false;" style="color: #FF6F00; font-weight: 600;">Last 1h</a> |
                                <a href="#" onclick="Dashboard.WAM.setPreset('recent', '10m'); return false;" style="color: #FF6F00;">Last 10m</a> |
                                <a href="#" onclick="Dashboard.WAM.setPreset('recent', 'now'); return false;" style="color: #FF6F00;">Now</a>
                            </div>
                        </div>
                        
                        <!-- EID Pattern and Action -->
                        <div style="flex: 0 0 auto; min-width: 220px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #BF360C;">EID Pattern</label>
                            <input type="text" id="wamEidPattern" value="metricsevolved*" 
                                   style="width: 100%; padding: 5px; border: 1px solid #FFB74D; border-radius: 4px; margin-bottom: 10px; background: #FFF8E1;"
                                   placeholder="e.g., metricsevolved*">
                            <button onclick="Dashboard.WAM.runHealthCheck()" 
                                    style="width: 100%; padding: 10px 16px; background: linear-gradient(135deg, #FF6F00 0%, #FF8F00 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.2s;"
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';">
                                ‚ö° RUN ET CHECK
                            </button>
                        </div>
                    </div>
                    
                    <!-- WAM Results Display -->
                    <div id="wamGeneralResults" style="margin-top: 20px; display: none;">
                        <!-- Results will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <span>Loading data...</span>
                </div>

                <!-- Results Info -->
                <div id="resultsInfo" class="results-info"></div>

                <!-- Data Table -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-sort="event_id" style="width: 35%">Traffic Event Identifier</th>
                            <th data-sort="rad_type" style="width: 12%">RAD Type</th>
                            <th data-sort="status" style="width: 10%">Health Status</th>
                            <th data-sort="score" style="width: 8%">Change %</th>
                            <th data-sort="current" style="width: 10%; text-align: right">Current Count</th>
                            <th data-sort="baseline12h" style="width: 10%; text-align: right">Expected Count</th>
                            <th data-sort="change" style="width: 15%">Business Impact</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Hidden elements for compatibility -->
    <div style="display: none;">
        <!-- API Status -->
        <span id="apiStatus"></span>

        <!-- Hidden form elements for ConfigEditor compatibility -->
        <button id="testApiBtn">Test API</button>
    </div>

    <!-- How It Works Modal -->
    <div id="howItWorksModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìñ How RAD Monitor Works</h2>
                <span class="close" onclick="closeHowItWorksModal()">&times;</span>
            </div>
            <div class="modal-body" id="howItWorksContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Advanced Editor Modal -->
    <div id="advancedEditorModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configuration Settings</h2>
                <span class="close" onclick="closeAdvancedEditor()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div id="configEditorFields">
                    <!-- Config fields will be loaded here -->
                </div>
                <div id="configEditorStatus" style="margin: 15px 0 10px 0; font-size: 13px; color: #666; text-align: center;"></div>
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <button onclick="ConfigEditor.saveConfig()" class="control-button" style="background: #4CAF50; padding: 8px 20px;">Apply Changes</button>
                    <button onclick="ConfigEditor.resetToDefaults()" class="control-button secondary" style="padding: 8px 20px;">Reset to Defaults</button>
                    <button onclick="closeAdvancedEditor()" class="control-button secondary" style="padding: 8px 20px;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Header controls styling */
        .container .header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 30px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .info-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .info-button:hover {
            background: #1976D2;
        }

        /* Modal styling */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 24px;
        }

        .close {
            color: #666;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .close:hover {
            background: #e0e0e0;
        }

        .modal-body {
            padding: 20px 25px;
            line-height: 1.5;
            color: #333;
        }

        .math-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }

        .math-section h3 {
            margin: 0 0 15px 0;
            color: #1976D2;
            font-size: 18px;
        }

        .math-section p {
            margin: 10px 0;
        }

        .formula {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            border: 1px solid #bbdefb;
        }

        .example {
            background: #fff3e0;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #ffcc02;
        }

        .example strong {
            color: #f57c00;
        }
    </style>

    <script>
        // How It Works Modal Functions
        function showHowItWorksModal() {
            const modal = document.getElementById('howItWorksModal');
            const content = document.getElementById('howItWorksContent');

            // Load the content
            content.innerHTML = generateHowItWorksContent();

            // Show modal
            modal.style.display = 'block';

            // Close on outside click
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeHowItWorksModal();
                },
            },
        }

        function closeHowItWorksModal() {
            document.getElementById('howItWorksModal').style.display = 'none';
        }

        // Advanced Editor Modal Functions
        async function showAdvancedEditor() {
            const modal = document.getElementById('advancedEditorModal');

            // Load the configuration
            await ConfigEditor.loadConfig();

            // Show modal
            modal.style.display = 'block';

            // Close on outside click
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeAdvancedEditor();
                }
            };
        }

        function closeAdvancedEditor() {
            document.getElementById('advancedEditorModal').style.display = 'none';
        }

        function generateHowItWorksContent() {
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="math-section" style="margin-bottom: 15px; padding: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px;">üìä How We Calculate</h3>
                            <div class="formula" style="margin: 8px 0; padding: 8px; font-size: 12px;">
                            <strong>Expected = Daily Avg √ó (Hours √∑ 24)</strong><br>
                            <strong>Ratio = Current √∑ Expected</strong><br>
                            <strong>Score:</strong> See volume rules ‚Üí
                            </div>
                            <div class="example" style="margin: 8px 0; padding: 10px; font-size: 12px;">
                                <strong>üìâ Visual Example:</strong><br>
                                Baseline: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 1000/day<br>
                                Current:  ‚ñà‚ñà 100 (expected 500)<br>
                                Ratio: 0.2 ‚Üí Score: -80% = CRITICAL üö®
                            </div>
                        </div>

                        <div class="math-section" style="margin-bottom: 15px; padding: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px;">üö® Status Thresholds</h3>
                            <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                <li><strong style="color: #d32f2f;">CRITICAL:</strong> ‚â§ -80% drop</li>
                                <li><strong style="color: #f57c00;">WARNING:</strong> -50% to -80% drop</li>
                                <li><strong style="color: #388e3c;">NORMAL:</strong> -50% to 0%</li>
                                <li><strong style="color: #1976d2;">INCREASED:</strong> > 0%</li>
                            </ul>
                        </div>

                        <div class="math-section" style="padding: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px;">‚ö†Ô∏è Common Gotchas</h3>
                            <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                <li>Weekend traffic differs from weekdays</li>
                                <li>Marketing campaigns skew baselines</li>
                                <li>Exclude maintenance windows</li>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <div class="math-section" style="margin-bottom: 15px; padding: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px;">üéõÔ∏è Configuration Tips</h3>
                            <div style="font-size: 13px;">
                                <p style="margin: 5px 0;"><strong>Quick Detection:</strong><br>
                                ‚Ä¢ Time: now-6h ‚Ä¢ Base: 3-5 days</p>
                                <p style="margin: 5px 0;"><strong>Stable Monitoring:</strong><br>
                                ‚Ä¢ Time: now-24h ‚Ä¢ Base: 7-10 days</p>
                                <p style="margin: 5px 0;"><strong>Investigation:</strong><br>
                                ‚Ä¢ Time: "24h ago to 8h ago"</p>
                            </div>
                        </div>

                        <div class="math-section" style="margin-bottom: 15px; padding: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px;">üìà Volume-Based Scoring</h3>
                            <div style="font-size: 13px;">
                                <p style="margin: 5px 0;"><strong>High (‚â•1000/day):</strong><br>
                                ‚Ä¢ Ratio < 0.5: Score = (1-ratio) √ó -100<br>
                                ‚Ä¢ Else: Score = (ratio-1) √ó 100</p>
                                <p style="margin: 5px 0;"><strong>Medium (100-1000):</strong><br>
                                ‚Ä¢ Ratio < 0.3: Score = (1-ratio) √ó -100<br>
                                ‚Ä¢ Else: Score = (ratio-1) √ó 100</p>
                                <p style="margin: 5px 0;"><strong>Low (<100):</strong> Filtered out</p>
                            </div>
                        </div>

                        <div class="math-section" style="padding: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px;">üöÄ Key Features</h3>
                            <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                <li><strong>Real-time:</strong> Updates live</li>
                                <li><strong>Smart filtering:</strong> Ignores noise</li>
                                <li><strong>Business impact:</strong> Shows actual loss/gain</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize UI helpers
        document.addEventListener('DOMContentLoaded', function() {
            // Update connection status
            window.updateConnectionStatus = function(connected, message) {
                const statusDot = document.querySelector('.status-dot');
                const statusText = document.querySelector('.status-text');

                if (statusDot && statusText) {
                    statusDot.style.backgroundColor = connected ? '#4CAF50' : '#f44336';
                    statusText.textContent = message || (connected ? 'Connected' : 'Disconnected');
                }
            };

            // Listen for API status changes
            if (window.unifiedAPI) {
                window.addEventListener('api:statusChange', () => {
                    const mode = window.unifiedAPI.getMode();
                    updateConnectionStatus(true, mode === 'fastapi' ? 'FastAPI Connected' : 'Connected');
                });
            }

            // Update quick stats display
            window.updateQuickStats = async function() {
                try {
                    const config = await ConfigService.getConfig();

                    // Update time range
                    const timeRangeEl = document.getElementById('quickTimeRange');
                    if (timeRangeEl) {
                        timeRangeEl.textContent = config.currentTimeRange || 'now-12h';
                    }

                    // Update baseline
                    const baselineEl = document.getElementById('quickBaseline');
                    if (baselineEl && config.baselineStart && config.baselineEnd) {
                        const start = new Date(config.baselineStart).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const end = new Date(config.baselineEnd).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        baselineEl.textContent = `${start} - ${end}`;
                    }

                    // Update theme
                    const themeEl = document.getElementById('quickTheme');
                    if (themeEl) {
                        themeEl.textContent = config.theme || 'light';
                    }
                } catch (error) {
                    console.debug('Error updating quick stats:', error);
                }
            };

            // Update quick stats on config changes
            if (window.ConfigService) {
                ConfigService.subscribe(() => {
                    updateQuickStats();
                });
                // Initial update
                setTimeout(updateQuickStats, 500);
            }

            // Baseline Health Check Functions
            window.setHealthyPreset = function(preset) {
                const now = new Date();
                let start, end;
                
                switch(preset) {
                    case 'july17':
                        start = new Date('2025-07-17T00:00:00');
                        end = new Date('2025-07-17T23:59:59');
                        break;
                    case 'last7days':
                        end = new Date(now);
                        start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'last30days':
                        end = new Date(now);
                        start = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                }
                
                document.getElementById('healthyStart').value = formatDateTimeLocal(start);
                document.getElementById('healthyEnd').value = formatDateTimeLocal(end);
            };
            
            window.setRecentPreset = function(preset) {
                const now = new Date();
                let start, end = now;
                
                switch(preset) {
                    case 'last15min':
                        start = new Date(now.getTime() - 15 * 60 * 1000);
                        break;
                    case 'last1hour':
                        start = new Date(now.getTime() - 60 * 60 * 1000);
                        break;
                    case 'last6hours':
                        start = new Date(now.getTime() - 6 * 60 * 60 * 1000);
                        break;
                }
                
                document.getElementById('recentStart').value = formatDateTimeLocal(start);
                document.getElementById('recentEnd').value = formatDateTimeLocal(end);
            };
            
            // formatDateTimeLocal function already exists in outer scope - removed duplicate
            
            window.runBaselineHealthCheck = async function() {
                const healthyStart = document.getElementById('healthyStart').value;
                const healthyEnd = document.getElementById('healthyEnd').value;
                const recentStart = document.getElementById('recentStart').value;
                const recentEnd = document.getElementById('recentEnd').value;
                const eidPattern = document.getElementById('eidPattern').value;
                
                if (!healthyStart || !healthyEnd || !recentStart || !recentEnd) {
                    alert('Please fill in all date/time fields');
                    return;
                }
                
                const resultsDiv = document.getElementById('baselineHealthResults');
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div><span style="margin-left: 10px;">Running health check...</span></div>';
                
                try {
                    // Get API client
                    const apiClient = window.apiClient || window.unifiedAPI;
                    if (!apiClient || !apiClient.compareWindows) {
                        throw new Error('API client not available or compareWindows method not found');
                    }
                    
                    // Convert datetime-local to ISO strings
                    const healthyStartISO = new Date(healthyStart).toISOString();
                    const healthyEndISO = new Date(healthyEnd).toISOString();
                    const recentStartISO = new Date(recentStart).toISOString();
                    const recentEndISO = new Date(recentEnd).toISOString();
                    
                    // Run comparison
                    const result = await apiClient.compareWindows(
                        healthyStartISO,
                        healthyEndISO,
                        recentStartISO,
                        recentEndISO,
                        eidPattern
                    );
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Comparison failed');
                    }
                    
                    // Display results
                    displayHealthCheckResults(result);
                    
                } catch (error) {
                    console.error('Health check failed:', error);
                    resultsDiv.innerHTML = `<div style="color: #f44336; padding: 15px; background: #ffebee; border-radius: 4px;">
                        <strong>Error:</strong> ${error.message}
                    </div>`;
                }
            };
            
            function displayHealthCheckResults(result) {
                const resultsDiv = document.getElementById('baselineHealthResults');
                
                // Determine status color and icon
                let statusColor, statusIcon, statusText;
                switch(result.status) {
                    case 'CRITICAL':
                        statusColor = '#f44336';
                        statusIcon = 'üö®';
                        statusText = 'CRITICAL - Traffic dropped significantly';
                        break;
                    case 'WARNING':
                        statusColor = '#ff9800';
                        statusIcon = '‚ö†Ô∏è';
                        statusText = 'WARNING - Traffic below normal';
                        break;
                    case 'INCREASED':
                        statusColor = '#2196F3';
                        statusIcon = 'üìà';
                        statusText = 'INCREASED - Traffic higher than baseline';
                        break;
                    default:
                        statusColor = '#4CAF50';
                        statusIcon = '‚úÖ';
                        statusText = 'NORMAL - Traffic within expected range';
                }
                
                const healthy = result.details.healthy;
                const recent = result.details.recent;
                const eidAnalysis = result.details.eidAnalysis;
                
                resultsDiv.innerHTML = `
                    <div style="border: 2px solid ${statusColor}; border-radius: 8px; padding: 20px; background: white;">
                        <div style="display: flex; align-items: center; margin-bottom: 20px;">
                            <span style="font-size: 32px; margin-right: 15px;">${statusIcon}</span>
                            <div>
                                <h4 style="margin: 0; color: ${statusColor}; font-size: 20px;">${statusText}</h4>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                    Traffic change: <strong style="color: ${statusColor};">${result.percentageDiff > 0 ? '+' : ''}${result.percentageDiff}%</strong>
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: #f5f5f5; padding: 15px; border-radius: 6px;">
                                <h5 style="margin: 0 0 10px 0; color: #333;">üìä Healthy Baseline</h5>
                                <div style="font-size: 14px; line-height: 1.6;">
                                    <div><strong>Events:</strong> ${healthy.eventCount.toLocaleString()}</div>
                                    <div><strong>Unique EIDs:</strong> ${healthy.uniqueEids}</div>
                                    <div style="margin-top: 8px;"><strong>Top EIDs:</strong></div>
                                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                                        ${healthy.topEids.map(eid => `<li>${eid.eid.split('.').slice(-2).join('.')} (${eid.count.toLocaleString()})</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                            
                            <div style="background: #f5f5f5; padding: 15px; border-radius: 6px;">
                                <h5 style="margin: 0 0 10px 0; color: #333;">üìà Recent Window</h5>
                                <div style="font-size: 14px; line-height: 1.6;">
                                    <div><strong>Events:</strong> ${recent.eventCount.toLocaleString()}</div>
                                    <div><strong>Unique EIDs:</strong> ${recent.uniqueEids}</div>
                                    <div style="margin-top: 8px;"><strong>Top EIDs:</strong></div>
                                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                                        ${recent.topEids.map(eid => `<li>${eid.eid.split('.').slice(-2).join('.')} (${eid.count.toLocaleString()})</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        ${(eidAnalysis.totalMissing > 0 || eidAnalysis.totalNew > 0) ? `
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 6px;">
                            <h5 style="margin: 0 0 10px 0; color: #856404;">üîç EID Analysis</h5>
                            ${eidAnalysis.totalMissing > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #d63031;">Missing EIDs (${eidAnalysis.totalMissing}):</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    ${eidAnalysis.missingEids.slice(0, 5).map(eid => eid.split('.').slice(-2).join('.')).join(', ')}
                                    ${eidAnalysis.totalMissing > 5 ? ` and ${eidAnalysis.totalMissing - 5} more...` : ''}
                                </div>
                            </div>
                            ` : ''}
                            ${eidAnalysis.totalNew > 0 ? `
                            <div>
                                <strong style="color: #00b894;">New EIDs (${eidAnalysis.totalNew}):</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    ${eidAnalysis.newEids.slice(0, 5).map(eid => eid.split('.').slice(-2).join('.')).join(', ')}
                                    ${eidAnalysis.totalNew > 5 ? ` and ${eidAnalysis.totalNew - 5} more...` : ''}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Initialize with default values
            setTimeout(() => {
                setHealthyPreset('july17');
                setRecentPreset('last15min');
            }, 1000);

            // ====================
            // WAM General ET Monitoring Functions
            // ====================
            
            // Initialize WAM namespace within Dashboard for architectural coherence
            window.Dashboard = window.Dashboard || {};
            Dashboard.WAM = {
                // Configuration aligned with existing patterns
                queryManager: null,
                
                /**
                 * Initialize WAM subsystem with proper event delegation
                 * Implements WeakMap-based memory management for long-running sessions
                 */
                init: function() {
                    this.queryManager = new WamQueryManager();
                    this.setupEventDelegation();
                    this.loadDefaultPresets();
                },
                
                /**
                 * Set WAM preset values with intelligent time window calculation
                 * Leverages existing TimeRangeUtils for consistency
                 */
                setPreset: function(type, preset) {
                const now = new Date();
                let start, end;
                
                if (type === 'baseline') {
                    switch(preset) {
                        case '6days':
                            // Ebube's pattern: 6 days ago baseline
                            end = new Date(now.getTime() - 6 * 24 * 60 * 60 * 1000);
                            end.setHours(23, 59, 59, 999);
                            start = new Date(end);
                            start.setHours(0, 0, 0, 0);
                            break;
                        case 'july17':
                            // Specific date baseline for ET testing
                            start = new Date('2025-07-17T00:00:00');
                            end = new Date('2025-07-17T23:59:59');
                            break;
                        case 'custom':
                            // Last 7 days for custom baseline
                            end = new Date(now);
                            start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                    }
                    
                    // Use existing formatDateTimeLocal from outer scope
                    document.getElementById('wamBaselineStart').value = formatDateTimeLocal(start);
                    document.getElementById('wamBaselineEnd').value = formatDateTimeLocal(end);
                    
                } else if (type === 'recent') {
                    end = now;
                    
                    switch(preset) {
                        case '1h':
                            start = new Date(now.getTime() - 60 * 60 * 1000);
                            break;
                        case '10m':
                            start = new Date(now.getTime() - 10 * 60 * 1000);
                            break;
                        case 'now':
                            // Last 5 minutes for "now"
                            start = new Date(now.getTime() - 5 * 60 * 1000);
                            break;
                    }
                    
                    document.getElementById('wamRecentStart').value = formatDateTimeLocal(start);
                    document.getElementById('wamRecentEnd').value = formatDateTimeLocal(end);
                }
            },
            
                /**
                 * Execute WAM General health check with advanced cardinality analysis
                 * Implements parallel query execution with AbortController support
                 */
                runHealthCheck: async function() {
                const baselineStart = document.getElementById('wamBaselineStart').value;
                const baselineEnd = document.getElementById('wamBaselineEnd').value;
                const recentStart = document.getElementById('wamRecentStart').value;
                const recentEnd = document.getElementById('wamRecentEnd').value;
                const eidPattern = document.getElementById('wamEidPattern').value || 'pandc.vnext.recommendations.metricsevolved*';
                
                // Validation using existing notification patterns
                if (!baselineStart || !baselineEnd || !recentStart || !recentEnd) {
                    this.showValidationError('Please fill in all date/time fields for WAM General analysis');
                    return;
                }
                
                const resultsDiv = document.getElementById('wamGeneralResults');
                resultsDiv.style.display = 'block';
                
                // Optimistic loading state with performance timing
                const startTime = performance.now();
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="spinner" style="border-color: #FF6F00; border-top-color: transparent;"></div>
                        <div style="margin-top: 15px; color: #E65100; font-weight: 600;">
                            ‚ö° Analyzing WAM General ET metrics...
                        </div>
                        <div style="margin-top: 5px; color: #666; font-size: 12px;">
                            Calculating unique visitor cardinality across time windows
                        </div>
                    </div>
                `;
                
                try {
                    // Get API client with fallback logic
                    // INTEGRATION PATTERN: Correctly leverages existing API client singleton
                    const apiClient = window.apiClient || window.unifiedAPI;
                    if (!apiClient || !apiClient.compareWindowsWamGeneral) {
                        throw new Error('WAM General API method not available. Please refresh the page.');
                    }
                    
                    // Convert datetime-local to ISO with timezone handling
                    const baselineStartISO = new Date(baselineStart).toISOString();
                    const baselineEndISO = new Date(baselineEnd).toISOString();
                    const recentStartISO = new Date(recentStart).toISOString();
                    const recentEndISO = new Date(recentEnd).toISOString();
                    
                    // Execute enhanced comparison with cardinality
                    const result = await apiClient.compareWindowsWamGeneral(
                        baselineStartISO,
                        baselineEndISO,
                        recentStartISO,
                        recentEndISO,
                        eidPattern
                    );
                    
                    const queryTime = Math.round(performance.now() - startTime);
                    
                    if (!result.success) {
                        throw new Error(result.error || 'WAM General comparison failed');
                    }
                    
                    // Display results with performance metrics
                    this.displayResults(result, queryTime);
                    
                } catch (error) {
                    console.error('WAM General health check failed:', error);
                    resultsDiv.innerHTML = `
                        <div style="background: #FFEBEE; border: 1px solid #FFCDD2; padding: 20px; border-radius: 8px;">
                            <div style="display: flex; align-items: center; color: #C62828;">
                                <span style="font-size: 24px; margin-right: 10px;">‚ùå</span>
                                <div>
                                    <strong>WAM General Analysis Error</strong>
                                    <div style="margin-top: 5px; font-size: 14px; color: #666;">${error.message}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            };
            
                /**
                 * Display WAM results with advanced visualization and drill-down capabilities
                 * Implements responsive grid layout with performance-optimized rendering
                 */
                displayResults: function(result, queryTime) {
                const resultsDiv = document.getElementById('wamGeneralResults');
                const summary = result.summary;
                const eidAnalysis = result.eidAnalysis || [];
                
                // Build comprehensive results display
                let html = `
                    <div style="background: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
                        <!-- Overall Status Header -->
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #FFE0B2;">
                            <div style="display: flex; align-items: center;">
                                <span style="font-size: 36px; margin-right: 15px;">${result.statusEmoji}</span>
                                <div>
                                    <h4 style="margin: 0; color: #E65100; font-size: 22px;">
                                        ${result.status} Status
                                    </h4>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                        Events: <strong style="color: ${result.percentageDiff.events < 0 ? '#D32F2F' : '#388E3C'};">
                                            ${result.percentageDiff.events > 0 ? '+' : ''}${result.percentageDiff.events}%
                                        </strong>
                                        | Visitors: <strong style="color: ${result.percentageDiff.visitors < 0 ? '#D32F2F' : '#388E3C'};">
                                            ${result.percentageDiff.visitors > 0 ? '+' : ''}${result.percentageDiff.visitors}%
                                        </strong>
                                    </p>
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 12px; color: #666;">
                                <div>Query Time: <strong>${queryTime}ms</strong></div>
                                <div>Pattern: <code style="background: #FFF3E0; padding: 2px 6px; border-radius: 3px;">${result.eidPattern}</code></div>
                            </div>
                        </div>
                        
                        <!-- Metrics Summary Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                            <div style="background: #FAFAFA; padding: 20px; border-radius: 6px; border: 1px solid #E0E0E0;">
                                <h5 style="margin: 0 0 15px 0; color: #424242; font-size: 16px; display: flex; align-items: center;">
                                    <span style="width: 8px; height: 8px; background: #4CAF50; border-radius: 50%; margin-right: 8px;"></span>
                                    Baseline Metrics
                                </h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: #1976D2;">
                                            ${summary.healthy.eventCount.toLocaleString()}
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 2px;">Total Events</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: #388E3C;">
                                            ${summary.healthy.uniqueVisitors.toLocaleString()}
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 2px;">Unique Visitors</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 20px; font-weight: 600; color: #FF6F00;">
                                            ${summary.healthy.uniqueEids}
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 2px;">Active EIDs</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 20px; font-weight: 600; color: #7B1FA2;">
                                            ${summary.healthy.avgEventsPerVisitor}
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 2px;">Avg Events/Visitor</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #FFF8E1; padding: 20px; border-radius: 6px; border: 1px solid #FFE082;">
                                <h5 style="margin: 0 0 15px 0; color: #E65100; font-size: 16px; display: flex; align-items: center;">
                                    <span style="width: 8px; height: 8px; background: #FF6F00; border-radius: 50%; margin-right: 8px;"></span>
                                    Recent Metrics
                                </h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: #1976D2;">
                                            ${summary.recent.eventCount.toLocaleString()}
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 2px;">Total Events</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: #388E3C;">
                                            ${summary.recent.uniqueVisitors.toLocaleString()}
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 2px;">Unique Visitors</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 20px; font-weight: 600; color: #FF6F00;">
                                            ${summary.recent.uniqueEids}
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 2px;">Active EIDs</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 20px; font-weight: 600; color: #7B1FA2;">
                                            ${summary.recent.avgEventsPerVisitor}
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 2px;">Avg Events/Visitor</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- EID-Level Analysis -->
                        ${eidAnalysis.length > 0 ? `
                        <div style="margin-top: 25px;">
                            <h5 style="margin: 0 0 15px 0; color: #424242; font-size: 16px;">
                                üîç EID-Level Analysis (${eidAnalysis.length} EIDs)
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">
                                ${eidAnalysis.slice(0, 20).map(eid => `
                                    <div class="wam-eid-card" data-eid="${eid.eid}" style="background: ${this.getEidBackground(eid.status)}; padding: 12px; border-radius: 6px; border: 1px solid ${this.getEidBorder(eid.status)};">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <span style="font-size: 18px;">${eid.statusEmoji}</span>
                                            <code style="font-size: 11px; background: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 3px;">
                                                ${eid.shortEid}
                                            </code>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                            <div>
                                                <div style="color: #666;">Events</div>
                                                <div style="font-weight: 600;">
                                                    ${eid.recent.events.toLocaleString()}
                                                    <span style="color: ${eid.eventDiff < 0 ? '#D32F2F' : '#388E3C'}; font-size: 11px;">
                                                        (${eid.eventDiff > 0 ? '+' : ''}${eid.eventDiff}%)
                                                    </span>
                                                </div>
                                            </div>
                                            <div>
                                                <div style="color: #666;">Visitors</div>
                                                <div style="font-weight: 600;">
                                                    ${eid.recent.visitors.toLocaleString()}
                                                    <span style="color: ${eid.visitorDiff < 0 ? '#D32F2F' : '#388E3C'}; font-size: 11px;">
                                                        (${eid.visitorDiff > 0 ? '+' : ''}${eid.visitorDiff}%)
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <a href="${eid.kibanaLink}" target="_blank" 
                                           style="display: inline-block; margin-top: 8px; font-size: 11px; color: #1976D2; text-decoration: none;"
                                           onmouseover="this.style.textDecoration='underline'"
                                           onmouseout="this.style.textDecoration='none'">
                                            üîó View in Kibana
                                        </a>
                                    </div>
                                `).join('')}
                            </div>
                            ${eidAnalysis.length > 20 ? `
                            <div style="margin-top: 12px; text-align: center; color: #666; font-size: 13px;">
                                Showing top 20 of ${eidAnalysis.length} EIDs
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Render with requestAnimationFrame for smooth updates
                // ARCHITECTURAL EXCELLENCE: Leverages browser's repaint cycle for 60fps rendering
                // This pattern prevents layout thrashing during data-intensive DOM updates
                requestAnimationFrame(() => {
                    resultsDiv.innerHTML = html;
                });
            },
            
                /**
                 * Helper function to determine EID background color based on status
                 * Implements accessible color contrast ratios (WCAG AAA)
                 */
                getEidBackground: function(status) {
                const backgrounds = {
                    'CRITICAL': '#FFEBEE',
                    'WARNING': '#FFF8E1',
                    'NORMAL': '#F1F8E9',
                    'INCREASED': '#E3F2FD',
                    'NEW': '#F3E5F5'
                };
                return backgrounds[status] || '#FAFAFA';
            },
                
                /**
                 * Helper function to determine EID border color based on status
                 */
                getEidBorder: function(status) {
                const borders = {
                    'CRITICAL': '#FFCDD2',
                    'WARNING': '#FFE082',
                    'NORMAL': '#DCEDC8',
                    'INCREASED': '#BBDEFB',
                    'NEW': '#E1BEE7'
                };
                return borders[status] || '#E0E0E0';
            }
                
                /**
                 * Show validation error using existing notification system
                 */
                showValidationError: function(message) {
                    const resultsDiv = document.getElementById('wamGeneralResults');
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `
                        <div style="background: #FFEBEE; border: 1px solid #FFCDD2; padding: 15px; border-radius: 8px;">
                            <span style="color: #D32F2F; font-weight: 600;">‚ö†Ô∏è ${message}</span>
                        </div>
                    `;
                    
                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        resultsDiv.style.display = 'none';
                    }, 3000);
                },
                
                /**
                 * Setup event delegation for memory-efficient hover effects
                 */
                setupEventDelegation: function() {
                    const resultsContainer = document.getElementById('wamGeneralResults');
                    
                    resultsContainer.addEventListener('mouseover', (e) => {
                        const card = e.target.closest('.wam-eid-card');
                        if (card) {
                            card.style.transform = 'translateY(-2px)';
                            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                        }
                    });
                    
                    resultsContainer.addEventListener('mouseout', (e) => {
                        const card = e.target.closest('.wam-eid-card');
                        if (card) {
                            card.style.transform = 'translateY(0)';
                            card.style.boxShadow = '';
                        }
                    });
                },
                
                /**
                 * Load default presets on initialization
                 */
                loadDefaultPresets: function() {
                    this.setPreset('baseline', '6days');
                    this.setPreset('recent', '1h');
                }
            };
            
            /**
             * WAM Query Manager for cancellable operations
             * Implements AbortController pattern for resource optimization
             */
            class WamQueryManager {
                constructor() {
                    this.activeQuery = null;
                }
                
                async execute(queryFn) {
                    // Cancel any existing query
                    if (this.activeQuery) {
                        this.activeQuery.abort();
                    }
                    
                    // Create new AbortController
                    this.activeQuery = new AbortController();
                    
                    try {
                        return await queryFn(this.activeQuery.signal);
                    } finally {
                        this.activeQuery = null;
                    }
                }
            }
            
            // Initialize WAM subsystem after DOM ready
            setTimeout(() => {
                Dashboard.WAM.init();
            }, 1200);

        });
    </script>
</body>
</html>
